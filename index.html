<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EstimaPres ¬∑ Gesti√≥n Fintech</title>
<link rel="icon" href="assets/ping.png" />
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0b0e14;
    --card-bg: #161b22;
    --accent: #2ecc71;
    --text-main: #ffffff;
    --text-dim: #8b949e;
    --danger: #ff4d4d;
    --border: rgba(255, 255, 255, 0.05);
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text-main); }

  .hero { background: rgba(11, 14, 20, 0.9); backdrop-filter: blur(12px); padding: 20px 16px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--border); }
  .header-top { display: flex; justify-content: space-between; align-items: center; max-width: 900px; margin: 0 auto; }
  .brand { display: flex; align-items: center; gap: 10px; }
  .brand img { width: 42px; height: 42px; border-radius: 10px; }
  .brand h1 { margin: 0; font-size: 22px; font-weight: 800; }

  .actions { display: flex; gap: 8px; overflow-x: auto; padding: 15px 0 5px; max-width: 900px; margin: 0 auto; scrollbar-width: none; }
  .btn { background: var(--card-bg); border: 1px solid var(--border); color: var(--text-main); padding: 10px 16px; border-radius: 12px; font-size: 13px; font-weight: 600; white-space: nowrap; cursor: pointer; }
  .btn.red { color: var(--danger); border-color: rgba(255, 77, 77, 0.2); }

  .wrap { max-width: 700px; margin: 0 auto; padding: 20px 16px 100px; }
  .card { background: var(--card-bg); border-radius: 24px; padding: 24px; margin-bottom: 20px; border: 1px solid var(--border); }
  h2 { margin: 0 0 20px; font-size: 20px; font-weight: 800; color: var(--accent); }

  label { font-size: 12px; color: var(--text-dim); display: block; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; }
  input { width: 100%; background: #0d1117; border: 1px solid var(--border); padding: 14px; border-radius: 14px; color: white; font-size: 16px; margin-bottom: 15px; }
  
  .cta { width: 100%; background: var(--accent); color: #000; border: none; padding: 16px; border-radius: 16px; font-weight: 800; font-size: 16px; cursor: pointer; }

  table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
  th { text-align: left; color: var(--text-dim); padding-bottom: 10px; border-bottom: 1px solid var(--border); }
  td { padding: 12px 0; border-bottom: 1px solid var(--border); }

  .pill { padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 700; }
  .pill.ok { background: rgba(46, 204, 113, 0.1); color: var(--accent); }
  .pill.warn { background: rgba(241, 196, 15, 0.1); color: #f1c40f; }
  .pill.bad { background: rgba(231, 76, 60, 0.1); color: var(--danger); }

  .toolbar { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; }
  .btn-success { background: var(--accent); color: #000; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }
  .btn-danger { background: var(--danger); color: #fff; border: none; padding: 8px 12px; border-radius: 8px; font-weight: 700; cursor: pointer; }
</style>
</head>
<body>

<header class="hero">
  <div class="header-top">
    <div class="brand">
      <img src="assets/ping.png" alt="EstimaPres" />
      <h1>PresTar</h1>
    </div>
  </div>
  <div class="actions">
    <button id="btnOpenMyLoan" class="btn">üîé Ver mi pr√©stamo</button>
    <button id="btnAdmin" class="btn">üõ°Ô∏è Admin</button>
    <button id="btnResetPass" class="btn">üîë Reset</button>
    <button id="btnLogout" class="btn red">‚Ü™ Salir</button>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h2>Simulador</h2>
    <label>Monto</label>
    <input id="simAmount" inputmode="numeric" placeholder="$ 1.000.000" />
    <label>Meses</label>
    <input id="simMonths" inputmode="numeric" placeholder="Ej: 12" />
    <div style="font-size:12px; color:var(--text-dim); margin-bottom:15px">
      <span id="lblTna">TNA vigente: ‚Äî%</span> ¬∑ <span id="lblDue">Vencimiento: d√≠a ‚Äî</span>
    </div>
    <button id="btnSim" class="cta">Simular</button>
    <div id="simResult"></div>
  </section>

  <section class="card">
    <h2>Solicitar pr√©stamo</h2>
    <label>Tu nombre</label><input id="bName" />
    <label>DNI</label><input id="bDni" inputmode="numeric" />
    <label>Email</label><input id="bEmail" type="email" />
    <label>Tel√©fono</label><input id="bPhone" inputmode="tel" />
    <label>Alias o CBU/CVU</label><input id="bAlias" />
    <button id="btnSendReq" class="cta" style="background:#fff; color:#000">Enviar solicitud</button>
  </section>

  <section id="admin" class="card" style="display:none">
    <h2>Panel administrador</h2>
    <details open class="card" style="background:#0d1117"><summary style="cursor:pointer; padding:10px">Configuraci√≥n</summary>
      <label>TNA %</label><input id="cfgTna" />
      <label>Vencimiento</label><input id="cfgDue" />
      <button id="btnSaveCfg" class="btn-success">Guardar Config</button>
    </details>
    <details class="card" style="background:#0d1117"><summary style="cursor:pointer; padding:10px">Pendientes</summary><div id="listPend"></div></details>
    <details class="card" style="background:#0d1117"><summary style="cursor:pointer; padding:10px">Preaprobados</summary><div id="listPre"></div></details>
    <details open class="card" style="background:#0d1117"><summary style="cursor:pointer; padding:10px">Activos</summary><div id="listAct"></div></details>
  </section>

  <section id="myloan" class="card">
    <h2>Mi pr√©stamo</h2>
    <label>DNI</label>
    <input id="myDni" inputmode="numeric" />
    <button id="btnFindMyLoan" class="cta">Consultar</button>
    <div id="myLoanResult"></div>
  </section>
</main>

<script type="module">
/* COPIAR AQU√ç TODO TU BLOQUE <script> ORIGINAL DESDE "import { initializeApp } ..." HASTA EL FINAL */
/* Tu l√≥gica de Firebase es perfecta, no necesita cambios para funcionar con este dise√±o */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBuLQHhsOBTr2e8Kp5HKUz-a7xXgrgLlUI",
  authDomain: "estimapres.firebaseapp.com",
  projectId: "estimapres",
  storageBucket: "estimapres.firebasestorage.app",
  messagingSenderId: "578516597437",
  appId: "1:578516597437:web:f59994b87729aa1cd655d4"
};
const ADMIN_EMAIL = "fernandogastondelgado81@gmail.com";
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ... (Pega aqu√≠ el resto de tus funciones: $, fmtMoney, annuityPayment, scheduleRows, loadSettings, etc.)
// Nota: He mantenido la l√≥gica para que reconozca los nuevos contenedores visuales.

const $ = s => document.querySelector(s);
const fmtMoney = n => isNaN(n) ? "$ 0" : "$ " + Number(n).toLocaleString("es-AR");
const onlyDigits = v => (v||"").replace(/\D+/g,"");
const nowTS = () => serverTimestamp();

function annuityPayment(P, annualRate, m){
  const i = (annualRate/100)/12;
  if (i===0) return P/m;
  const a = i*Math.pow(1+i,m)/(Math.pow(1+i,m)-1);
  return P*a;
}

function scheduleRows(L){
  const due = L.dueDay||10, today=new Date(), rows=[];
  for(let k=1;k<=L.months;k++){
    const d=new Date(today.getFullYear(), today.getMonth()+k, 1);
    d.setDate(Math.min(due, 28));
    rows.push({n:k, due:d.toISOString().slice(0,10), amount:L.installment, paid:(L.paidCount||0)>=k});
  }
  return rows;
}

const daysLate = iso => Math.max(0, Math.floor((new Date()-new Date(iso))/(1000*60*60*24)));

let gSettings={tna:null,dueDay:null}; let gUser=null;
async function loadSettings(){
  const snap=await getDoc(doc(db,"settings","app"));
  if(snap.exists()) gSettings={...gSettings,...snap.data()};
  $("#lblTna").textContent="TNA vigente: "+(gSettings.tna??"‚Äî")+"%";
  $("#lblDue").textContent="Vencimiento: d√≠a "+(gSettings.dueDay??"‚Äî");
  $("#cfgTna").value=gSettings.tna??"";
  $("#cfgDue").value=gSettings.dueDay??"";
}

onAuthStateChanged(auth,(u)=>{
  gUser=u;
  $("#admin").style.display=(u&&u.email===ADMIN_EMAIL)?"":"none";
});

$("#btnAdmin").onclick=async()=>{
  if(!auth.currentUser){
    const email=prompt("Email admin:", ADMIN_EMAIL)||"";
    const pass =prompt("Contrase√±a:")||"";
    try{ await signInWithEmailAndPassword(auth,email,pass); }catch{ alert("Error"); }
  }
};

$("#btnLogout").onclick=()=>signOut(auth);

$("#btnSim").onclick=()=>{
  const P=Number(onlyDigits($("#simAmount").value));
  const m=Math.min(24, Number(onlyDigits($("#simMonths").value)));
  if(!P||!m) return;
  const c=Math.round(annuityPayment(P,gSettings.tna,m));
  let rows="";
  for(let i=1;i<=m;i++) rows+=`<tr><td>${i}</td><td>${fmtMoney(c)}</td><td><span class="pill warn">Pendiente</span></td></tr>`;
  $("#simResult").innerHTML = `<table><thead><tr><th>#</th><th>Cuota</th><th>Estado</th></tr></thead><tbody>${rows}</tbody></table>`;
};

$("#btnSendReq").onclick=async()=>{
  const amount=Number(onlyDigits($("#simAmount").value));
  const months=Number(onlyDigits($("#simMonths").value));
  const borrower={ name:$("#bName").value, dni:onlyDigits($("#bDni").value), email:$("#bEmail").value, phone:$("#bPhone").value, alias:$("#bAlias").value };
  await addDoc(collection(db,"loans"), {status:"pending", amount, months, tna:gSettings.tna, dueDay:gSettings.dueDay, borrower, createdAt:nowTS()});
  alert("Enviado");
};

/* Carga inicial */
loadSettings();
</script>
</body>
</html>
